#!/usr/bin/env fish
# AuraOS Post-Installation Script
# Installs AUR dependencies and builds aura-cli + aura-shell

# Parse arguments
argparse -n 'install-aura-post' -X 0 \
    'h/help' \
    'noconfirm' \
    'aur-helper=!contains -- "$_flag_value" yay paru' \
    -- $argv
or exit

# Print help
if set -q _flag_h
    echo 'usage: install-aura-post [-h] [--noconfirm] [--aur-helper=yay|paru]'
    echo
    echo 'AuraOS post-installation script'
    echo 'Installs AUR dependencies and builds aura-cli + aura-shell'
    echo
    echo 'options:'
    echo '  -h, --help                  show this help message and exit'
    echo '  --noconfirm                 do not confirm package installation'
    echo '  --aur-helper=[yay|paru]     the AUR helper to use (default: yay)'
    exit
end

# Helper functions
function log -a text
    set_color cyan
    echo ":: $text"
    set_color normal
end

function error -a text
    set_color red
    echo "❌ ERROR: $text"
    set_color normal
end

function success -a text
    set_color green
    echo "✅ $text"
    set_color normal
end

# Variables
set -q _flag_noconfirm && set noconfirm '--noconfirm' || set noconfirm ''
set -q _flag_aur_helper && set aur_helper $_flag_aur_helper || set aur_helper yay

# Startup banner
set_color cyan
echo '╔═══════════════════════════════════════════════════════════════════╗'
echo '║         Complete Aura Installation (CLI + Shell)                 ║'
echo '╚═══════════════════════════════════════════════════════════════════╝'
set_color normal
echo

# Check for source code
log "Checking for source code..."
set cli_exists false
set shell_exists false

if test -d $HOME/.local/src/aura-cli
    success "aura-cli source found at ~/.local/src/aura-cli"
    set cli_exists true
else
    error "aura-cli source NOT found at ~/.local/src/aura-cli"
end

if test -d $HOME/.config/quickshell/aura
    success "aura-shell source found at ~/.config/quickshell/aura"
    set shell_exists true
else
    error "aura-shell source NOT found at ~/.config/quickshell/aura"
end

if test $cli_exists = false -o $shell_exists = false
    error "Missing source code! Cannot continue."
    exit 1
end

echo

# Install AUR helper if not already installed
if ! pacman -Q $aur_helper &> /dev/null
    log "$aur_helper not installed. Installing..."

    # Install build dependencies
    sudo pacman -Syu --needed git base-devel $noconfirm

    # Clone and build AUR helper
    cd /tmp
    git clone https://aur.archlinux.org/$aur_helper.git
    cd $aur_helper
    makepkg -si $noconfirm
    cd ..
    rm -rf $aur_helper

    # Setup AUR helper
    if test $aur_helper = yay
        $aur_helper -Y --gendb
        $aur_helper -Y --devel --save
    else
        $aur_helper --gendb
    end

    success "$aur_helper installed!"
else
    log "$aur_helper is already installed"
end

echo

# Check AUR dependencies (skip if already installed during ISO installation)
log "Checking AUR dependencies..."

set aur_packages_file $HOME/.local/share/aura/install/aura-aur.packages

if test -f $aur_packages_file
    # Read packages from file (filter comments and blank lines)
    set all_aur_packages (grep -v '^#' $aur_packages_file | grep -v '^$')

    # Filter out already-installed packages
    set aur_packages
    for pkg in $all_aur_packages
        if not pacman -Q $pkg &>/dev/null
            set -a aur_packages $pkg
        end
    end

    if test (count $aur_packages) -gt 0
        log "Installing "(count $aur_packages)" missing AUR packages..."
        echo "This may take a while as packages are built from source..."

        # Install missing packages
        $aur_helper -S --needed --removemake --cleanafter $noconfirm $aur_packages
        or begin
            error "Some AUR packages failed to install"
            echo "Continuing anyway..."
        end

        success "AUR dependencies installed!"
    else
        success "All AUR dependencies already installed!"
    end
else
    error "aura-aur.packages not found at $aur_packages_file"
    echo "You may need to install dependencies manually"
end

echo

# Install build dependencies for aura-cli
log "Installing build dependencies for aura-cli (python-build, python-installer, hatchling)..."
sudo pacman -S --noconfirm --needed python-build python-installer python-hatchling python-hatch-vcs
or begin
    error "Failed to install Python build dependencies"
    echo "aura-cli build will likely fail without these packages"
end

echo

# Build aura-cli
log "Building aura-cli..."
cd $HOME/.local/src/aura-cli

python -m build --wheel
or begin
    error "Failed to build aura-cli"
    set cli_failed true
end

if not set -q cli_failed
    log "Installing aura-cli..."
    # Find the wheel file (Fish doesn't expand * in command arguments)
    set wheel_file (ls dist/*.whl 2>/dev/null | head -1)
    if test -n "$wheel_file"
        sudo python -m installer "$wheel_file"
        or begin
            error "Failed to install aura-cli"
            set cli_failed true
        end
    else
        error "No wheel file found in dist/"
        set cli_failed true
    end
end

if not set -q cli_failed
    # Install fish completions
    sudo mkdir -p /usr/share/fish/vendor_completions.d
    sudo cp completions/aura.fish /usr/share/fish/vendor_completions.d/aura.fish 2>/dev/null
    or true

    success "aura-cli installed successfully!"
end

echo

# Install build dependencies for aura-shell
log "Installing build dependencies for aura-shell (cmake, ninja)..."
sudo pacman -S --noconfirm --needed cmake ninja
or begin
    error "Failed to install build dependencies"
    echo "aura-shell build will likely fail without cmake and ninja"
end

echo

# Build aura-shell
log "Building aura-shell..."
cd $HOME/.config/quickshell/aura

# Set VERSION and GIT_REVISION since this isn't a git repo
cmake -B build -G Ninja \
    -DCMAKE_BUILD_TYPE=Release \
    -DCMAKE_INSTALL_PREFIX=/ \
    -DINSTALL_QSCONFDIR=~/.config/quickshell/aura \
    -DVERSION=1.0.0 \
    -DGIT_REVISION=installed
or begin
    error "Failed to configure aura-shell build"
    set shell_failed true
end

if not set -q shell_failed
    cmake --build build
    or begin
        error "Failed to build aura-shell"
        set shell_failed true
    end
end

if not set -q shell_failed
    log "Installing aura-shell..."
    sudo cmake --install build
    or begin
        error "Failed to install aura-shell"
        set shell_failed true
    end

    # Fix permissions
    sudo chown -R $USER ~/.config/quickshell/aura 2>/dev/null
    or true

    success "aura-shell installed successfully!"
end

echo

# Final summary
set_color cyan
echo '╔═══════════════════════════════════════════════════════════════════╗'
echo '║                  Installation Complete!                          ║'
echo '╚═══════════════════════════════════════════════════════════════════╝'
set_color normal
echo

log "Installation Summary:"
echo

if not set -q cli_failed
    success "aura-cli - Available via 'aura' command"
else
    error "aura-cli - Installation failed"
end

if not set -q shell_failed
    success "aura-shell - Available via 'aura shell -d'"
else
    error "aura-shell - Installation failed"
end

success "All configs in ~/.config/"
echo

# Next steps
if not set -q cli_failed; and not set -q shell_failed
    log "Next steps:"
    echo "  1. Log out from GNOME (top-right → Power → Log Out)"
    echo "  2. At GDM login screen, click the gear icon ⚙️"
    echo "  3. Select 'Hyprland (UWSM)'"
    echo "  4. Log back in and enjoy Aura! ✨"
else
    error "Some components failed to install."
    echo
    log "Troubleshooting:"
    echo "  - Check the error messages above"
    echo "  - Make sure all AUR dependencies installed correctly"
    echo "  - Try installing missing packages manually with: $aur_helper -S <package-name>"
    echo "  - Run this script again after fixing dependencies"
end
